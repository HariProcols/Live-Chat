<!DOCTYPE html>
<html>
<head>
    <title>Live Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.2/dist/index.js"></script>
    <style>
        #chat-container {
            width: 90%;
            margin: 0 auto;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            background: #fff;
            height: 75vh;
            overflow-y: auto;
            padding: 20px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.07);
            font-size: 1.05rem;
            margin-bottom: 10px;
        }
        .chat-message {
            margin-bottom: 12px;
            padding: 8px 14px;
            border-radius: 18px;
            background: #e9ecef;
            display: inline-block;
            max-width: 80%;
            word-break: break-word;
        }
        .chat-message.me {
            background: #d1e7dd;
            align-self: flex-end;
            margin-left: auto;
        }
        .chat-username {
            font-weight: 600;
            color: #198754;
            margin-right: 6px;
        }
        .bar {
            width: 100%;
            background-color: #fff;
            border-top: 1px solid #e0e0e0;
            padding: 12px;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.04);
            display: flex;
            gap: 8px;
            align-items: center;
        }
        #message-input {
            flex: 1;
        }
        #file-input {
            display: none;
        }
        .file-btn {
            cursor: pointer;
        }
        #typing-status {
            font-size: 0.9rem;
            color: #6c757d;
            margin-left: 20px;
            height: 1rem;
        }
    </style>
</head>
<body>
<div id="bg">
    <h2 style="text-align:center;" class="my-3">Live Chat</h2>
    <!-- CSRF token for JS -->
    <input type="hidden" id="csrf-token" value="{{ csrf_token }}">
    <div id="chat-container" class="d-flex flex-column"></div>
    <div id="typing-status" class="text-start px-4"></div>
    <div class="bar px-3">
        <label for="file-input" class="btn btn-outline-secondary file-btn">ðŸ“Ž</label>
        <input type="file" id="file-input">
        <button id="emoji-btn" class="btn btn-outline-light">ðŸ˜Š</button>
        <input id="message-input" type="text" class="form-control" placeholder="Type your message...">
        <button class="btn btn-success" id="send-btn">Send</button>
    </div>
</div>

<script>
    const username = prompt("Enter your display name:");
    const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/');
    const container = document.getElementById('chat-container');
    const input = document.getElementById('message-input');
    const button = document.getElementById('send-btn');
    const fileInput = document.getElementById('file-input');
    const typingStatus = document.getElementById('typing-status');
    const csrfToken = document.getElementById('csrf-token').value;

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);

        // Typing indicator
        if (data.typing !== undefined) {
            typingStatus.textContent = data.typing ? `${data.username} is typing...` : '';
            if (!data.typing) {
                setTimeout(() => { typingStatus.textContent = ''; }, 1000);
            }
            return;
        }

        // Chat message display
        const msgElem = document.createElement('div');
        msgElem.className = 'chat-message';

        const usernameElem = document.createElement('span');
        usernameElem.className = 'chat-username';
        usernameElem.textContent = data.username + ': ';
        msgElem.appendChild(usernameElem);

        if (data.message) {
            msgElem.append(data.message);
        }

        if (data.file_url) {
            if (data.is_image) {
                const img = document.createElement('img');
                img.src = data.file_url;
                img.alt = 'image';
                img.style.maxWidth = '250px';
                img.style.display = 'block';
                img.style.marginTop = '5px';
                msgElem.appendChild(img);
            } else {
                const a = document.createElement('a');
                a.href = data.file_url;
                a.download = '';
                a.textContent = 'ðŸ“Ž Download File';
                a.style.display = 'block';
                a.style.marginTop = '5px';
                msgElem.appendChild(a);
            }
        }

        container.appendChild(msgElem);
        container.scrollTop = container.scrollHeight;
    };

    button.onclick = () => {
        const msg = input.value.trim();
        if (msg !== "") {
            chatSocket.send(JSON.stringify({
                'username': username,
                'message': msg
            }));
            input.value = '';
        }
    };

    input.addEventListener("keyup", function(e) {
        if (e.key === 'Enter') button.click();
    });

    fileInput.addEventListener("change", function() {
        const file = fileInput.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);
        formData.append('username', username);

        fetch('/upload/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        }).then(res => res.json())
          .then(data => {
              if (data.status === 'ok') {
                  console.log('File uploaded:', data.url);
              } else {
                  alert("Upload failed.");
              }
          });

        fileInput.value = '';  // Reset input
    });

    // Typing indicator logic
    let typing = false;
    let typingTimeout;

    input.addEventListener('input', () => {
        if (!typing) {
            typing = true;
            chatSocket.send(JSON.stringify({
                'username': username,
                'typing': true
            }));
        }

        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            typing = false;
            chatSocket.send(JSON.stringify({
                'username': username,
                'typing': false
            }));
        }, 1000);
    });

    // Emoji Picker
    const picker = new EmojiButton();
    const emojiBtn = document.getElementById('emoji-btn');

    picker.on('emoji', emoji => {
        input.value += emoji;
        input.focus();
    });

    emojiBtn.addEventListener('click', () => {
        picker.togglePicker(emojiBtn);
    });
</script>

<!-- Vanta Fog Background -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.fog.min.js"></script>
<script>
    VANTA.FOG({
        el: "#bg",
        mouseControls: true,
        touchControls: true,
        gyroControls: false,
        minHeight: 200.00,
        minWidth: 200.00
    })
</script>
</body>
</html>
